name: Check PDF and Notify Slack / Restart EC2

on:
  schedule:
    # –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç —Å 08:30 –¥–æ 23:00
    #- cron: '*/10 8-22 * * *'   # —Å 8:00 –¥–æ 22:59 –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
    #- cron: '30 23 * * *'       # –≤ 23:30 –æ–¥–∏–Ω –∑–∞–ø—É—Å–∫
    # –∫–∞–∂–¥—ã–π —á–∞—Å —Å 00:00 –¥–æ 08:29
    - cron: '0 3-6 * * *'
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  check-pdf:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Run PDF check
        id: check
        run: node check-pdf.js
        continue-on-error: true

      - name: Notify Slack on PDF failure
        if: steps.check.outcome == 'failure'
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"‚ùå *PDF check failed!*\nURL: https://fg-trondheim.marscloud.dev/pdf-page/giftcard/608be9c29984d900219cd4b5\"}" \
          ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Fully restart EC2 instance if PDF check failed
        if: steps.check.outcome == 'failure'
        run: |
          echo "‚ö†Ô∏è PDF –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é EC2-–∏–Ω—Å—Ç–∞–Ω—Å ${{ secrets.EC2_INSTANCE_ID }}..."
          aws ec2 stop-instances \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --region ${{ secrets.AWS_REGION }}

          echo "‚åõ –û–∂–∏–¥–∞—é –ø–æ–ª–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ EC2..."
          aws ec2 wait instance-stopped \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --region ${{ secrets.AWS_REGION }}

          echo "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫–∞—é EC2-–∏–Ω—Å—Ç–∞–Ω—Å –∑–∞–Ω–æ–≤–æ..."
          aws ec2 start-instances \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --region ${{ secrets.AWS_REGION }}

          echo "üì£ –û—Ç–ø—Ä–∞–≤–ª—è—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Slack..."
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"üîÅ *EC2 instance \`${{ secrets.EC2_INSTANCE_ID }}\` restarted* –ø–æ—Å–ª–µ —Å–±–æ—è PDF.\"}" \
          ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
